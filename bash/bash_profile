#!/usr/bin/env bash
#
# Module: bash_profile
# Description: Main bash profile - entry point for dotfiles
# Dependencies: All dotfiles modules
# URL: https://github.com/stavxyz/dotfiles

# ============================================================================
# Environment Setup
# ============================================================================

export ITERM_ENABLE_SHELL_INTEGRATION_WITH_TMUX=1
export BASH_SILENCE_DEPRECATION_WARNING=1
export DOTFILES_DIR=${DOTFILES_DIR:-~/dotfiles}

# PATH construction
export PATH="\
~/local/bin:\
/usr/local/bin:\
/usr/local/sbin:\
/usr/local/lib:\
/usr/bin:\
/bin:\
/usr/sbin:\
/sbin:\
/opt/X11/bin:\
~/.pyenv/bin:\
~/.local/bin:\
/opt/homebrew/opt/openjdk/bin:\
$PATH"

echo 'üíô'

# ============================================================================
# Bootstrap Utilities
# ============================================================================

errcho() { printf "%s\n" "$@" 1>&2; }
errxit() { errcho "$@"; exit 1; }
debug() { [[ -n "${DOTFILES_DEBUG:-}" ]] && errcho "$@"; }

# shellcheck disable=SC2120
_err() {
  errcho "$@"
  if [[ -n "${1:-}" ]]; then
    local msg="‚è© Error at line ${1} of ${BASH_SOURCE:-${0}}"
    [[ -n "${2:-}" ]] && msg="${msg} in function '${2}'"
    errcho "$msg"
  fi
  errcho "‚õîÔ∏è Script failed."
}

_sigint() { errcho "üçø Script discontinued."; exit 1; }

trap '_err ${LINENO} ${FUNCNAME:-}' ERR
trap '_sigint' SIGHUP SIGINT SIGTERM

# ============================================================================
# Module Loading
# ============================================================================

[[ ! -d "${DOTFILES_DIR}" ]] && errcho 'dotfiles directory not found' && exit 0

# Convention: Auto-load all modules from bash/source/ in numeric order
for module in "${DOTFILES_DIR}"/bash/source/[0-9][0-9]-*.sh; do
  if [[ -f "$module" ]]; then
    debug "sourcing ${module##*/}"
    source "$module"
  fi
done

# Conditional: Homebrew (if brew exists)
command_exists brew && source "${DOTFILES_DIR}/homebrew/homebrew.sh"

# Lazy loading setup (function calls, not file sourcing)
setup_lazy_pyenv
setup_lazy_direnv
load_completions

# Platform-specific modules (macOS only)
if [[ $OSTYPE =~ darwin ]]; then
  source "${DOTFILES_DIR}/osx/osx.sh"
  source "${DOTFILES_DIR}/karabiner/karabiner.sh"
  source "${DOTFILES_DIR}/term/iterm2.sh"
fi

# ============================================================================
# Editor Preferences
# ============================================================================

export VISUAL=nvim EDITOR=nvim GIT_EDITOR=nvim
alias vim="nvim" vi="nvim" oldvim="\vim"

# ============================================================================
# Interactive Mode
# ============================================================================

# Allow interactive commands to fail without triggering ERR trap
set +e

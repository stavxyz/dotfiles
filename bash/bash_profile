#!/usr/bin/env bash
#
# Module: bash_profile
# Description: Main bash profile - entry point for dotfiles
# Dependencies: All dotfiles modules
# URL: https://github.com/stavxyz/dotfiles

export ITERM_ENABLE_SHELL_INTEGRATION_WITH_TMUX=1
export BASH_SILENCE_DEPRECATION_WARNING=1

export PATH=~/local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/lib:/usr/bin:/bin:/usr/sbin:/sbin:/opt/X11/bin:~/.pyenv/bin:~/.local/bin:/opt/homebrew/opt/openjdk/bin:$PATH

# The primary requirement for using the dotfiles project
# is setting DOTFILES_DIR...
# https://github.com/samstav/dotfiles
export DOTFILES_DIR=${DOTFILES_DIR:-~/dotfiles}

echo 'üíô'

errcho() {
  printf "%s\n" "$@" 1>&2
}

errxit ()
{
  errcho "$@"
  exit 1
}

#DOTFILES_DEBUG=1
debug ()
{
  if [ -n "${DOTFILES_DEBUG:-''}" ]; then
    errcho "$@"
  fi
}



# shellcheck disable=SC2120
_err() {
  errcho "$@"
  if [ -n "${1:-}" ]; then
    _errmsg="‚è© Error at line ${1} of ${BASH_SOURCE:-${0}}"
    if [ -n "${2:-}" ]; then
      _errmsg="${_errmsg} in function '${2}'"
    fi
    errcho "${_errmsg}"
  fi
  errcho "‚õîÔ∏è Script failed."
}

_sigint() {
  errcho "üçø Script discontinued."
  exit 1
}

trap '_err ${LINENO} ${FUNCNAME:-}' ERR
trap '_sigint' SIGHUP SIGINT SIGTERM

if [ ! -d "${DOTFILES_DIR}" ]; then
  errcho 'dotfiles directory not found'
else
  # Load core modules first
  debug "sourcing utils.sh"
  source "${DOTFILES_DIR}/bash/utils.sh"

  debug "sourcing config.sh"
  source "${DOTFILES_DIR}/bash/config.sh"

  debug "sourcing cache.sh"
  source "${DOTFILES_DIR}/bash/cache.sh"

  debug "sourcing lazy.sh"
  source "${DOTFILES_DIR}/bash/lazy.sh"

  debug "sourcing autocomplete-lazy.sh"
  source "${DOTFILES_DIR}/bash/autocomplete-lazy.sh"

  debug "sourcing dotfiles.sh"
  source "${DOTFILES_DIR}/bash/dotfiles.sh"
  debug "sourcing prompt.sh"
  source "${DOTFILES_DIR}/bash/prompt.sh"

  # Only source homebrew if brew command exists
  debug "sourcing homebrew.sh"
  source_if_command_exists "brew" "${DOTFILES_DIR}/homebrew/homebrew.sh"

  # Setup lazy loading for pyenv (replaces direct python.sh sourcing)
  debug "setting up lazy pyenv"
  setup_lazy_pyenv

  debug "looking for bash/history.sh"
  if [[ -f "${DOTFILES_DIR}/bash/history.sh" ]]; then
    debug "sourcing bash/history.sh"
    source "${DOTFILES_DIR}/bash/history.sh"
  fi
  debug "sourcing bash/fzf.sh"
  source "${DOTFILES_DIR}/bash/fzf.sh"
  debug "sourcing bash/volta.sh"
  source "${DOTFILES_DIR}/bash/volta.sh"
  if [[ $OSTYPE =~ "darwin" ]]; then
    debug "sourcing osx.sh"
    source "${DOTFILES_DIR}/osx/osx.sh"
    debug "sourcing karabiner.sh"
    source "${DOTFILES_DIR}/karabiner/karabiner.sh"

    debug "sourcing iterm2.sh"
    source "${DOTFILES_DIR}/term/iterm2.sh"
  fi

  # Load completions (async if lazy loading enabled)
  debug "loading completions"
  load_completions

  # Setup lazy loading for direnv (replaces direct direnv.sh sourcing)
  debug "setting up lazy direnv"
  setup_lazy_direnv
  debug "sourcing colors.sh"
  source "${DOTFILES_DIR}/bash/colors.sh"
  debug "sourcing aliases.sh"
  source "${DOTFILES_DIR}/bash/aliases.sh"
fi

# vim please
export VISUAL=nvim
export EDITOR=nvim
export GIT_EDITOR=nvim

alias vim="nvim"
alias vi="nvim"
alias oldvim="\vim"

# Allow interactive commands to fail without triggering ERR trap
set +e

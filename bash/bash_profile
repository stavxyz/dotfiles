#!/usr/bin/env bash
#
# Module: bash_profile
# Description: Main bash profile - entry point for dotfiles
# Dependencies: All dotfiles modules
# URL: https://github.com/stavxyz/dotfiles

# ============================================================================
# Environment Setup
# ============================================================================

export ITERM_ENABLE_SHELL_INTEGRATION_WITH_TMUX=1
export BASH_SILENCE_DEPRECATION_WARNING=1
export DOTFILES_DIR=${DOTFILES_DIR:-~/dotfiles}

# PATH construction
export PATH="\
$HOME/local/bin:\
/usr/local/bin:\
/usr/local/sbin:\
/usr/local/lib:\
/usr/bin:\
/bin:\
/usr/sbin:\
/sbin:\
/opt/X11/bin:\
$HOME/.pyenv/bin:\
$HOME/.local/bin:\
/opt/homebrew/opt/openjdk/bin:\
$PATH"

echo 'ðŸ’™'

# ============================================================================
# Bootstrap Utilities
# ============================================================================

errcho() { printf "%s\n" "$@" 1>&2; }
errxit() { errcho "$@"; exit 1; }
debug() {
  if [[ -n "${DOTFILES_DEBUG:-}" ]]; then
    errcho "$@"
  fi
}

# shellcheck disable=SC2120
_err() {
  errcho "$@"
  if [[ -n "${1:-}" ]]; then
    # Show the actual file and line where the error occurred
    local line="${1}"
    local func="${2:-}"
    local source_file="${BASH_SOURCE[1]:-${BASH_SOURCE[0]:-$0}}"

    # Show relative path if it's in dotfiles
    if [[ "$source_file" == "${DOTFILES_DIR}"* ]]; then
      source_file="${source_file#${DOTFILES_DIR}/}"
    fi

    local msg="â© Error at ${source_file}:${line}"
    [[ -n "$func" ]] && msg="${msg} in function '${func}'"
    errcho "$msg"
  fi
  errcho "â›”ï¸ Script failed."
}

_sigint() { errcho "ðŸ¿ Script discontinued."; exit 1; }

trap '_err ${LINENO} ${FUNCNAME:-}' ERR
trap '_sigint' SIGHUP SIGINT SIGTERM

# Propagate ERR trap to sourced scripts and functions
set -E

# ============================================================================
# Module Loading
# ============================================================================

[[ ! -d "${DOTFILES_DIR}" ]] && errcho 'dotfiles directory not found' && exit 0

# Detect platform (strip version numbers: darwin24.5.0 â†’ darwin)
platform="${OSTYPE%%[0-9]*}"

# Static modules: Always sourced (fast operations)

# Cross-platform static modules
for module in "${DOTFILES_DIR}"/modules/static/[0-9][0-9]-*.sh; do
  if [[ -f "$module" ]]; then
    debug "sourcing ${module##*/}"
    source "$module"
  fi
done

# Platform-specific static modules
if [[ -d "${DOTFILES_DIR}/modules/static/${platform}" ]]; then
  for module in "${DOTFILES_DIR}"/modules/static/"${platform}"/[0-9][0-9]-*.sh; do
    if [[ -f "$module" ]]; then
      debug "sourcing platform-specific ${module##*/}"
      source "$module"
    fi
  done
fi

# Dynamic modules: Only run if file content changed (system modifications)

# Cross-platform dynamic modules
for module in "${DOTFILES_DIR}"/modules/dynamic/*.sh; do
  if [[ -f "$module" ]]; then
    module_name="$(basename "$module" .sh)"
    debug "checking dynamic module: $module_name"
    run_if_changed "$module_name" "$module" "source \"$module\""
  fi
done

# Platform-specific dynamic modules
if [[ -d "${DOTFILES_DIR}/modules/dynamic/${platform}" ]]; then
  for module in "${DOTFILES_DIR}"/modules/dynamic/"${platform}"/*.sh; do
    if [[ -f "$module" ]]; then
      module_name="$(basename "$module" .sh)"
      debug "checking platform-specific dynamic module: $module_name"
      run_if_changed "$module_name" "$module" "source \"$module\""
    fi
  done
fi

# Disable strict error checking for external scripts (completions, etc.)
set +E

# Load completions (lazy loading is now handled in individual language modules)
load_completions

# ============================================================================
# Editor Preferences
# ============================================================================

# Use neovim if available, otherwise fall back to vim
if command -v nvim &>/dev/null; then
  export VISUAL=nvim EDITOR=nvim GIT_EDITOR=nvim
  alias vim="nvim" vi="nvim" oldvim="\vim"
else
  export VISUAL=vim EDITOR=vim GIT_EDITOR=vim
fi

# ============================================================================
# Interactive Mode
# ============================================================================

# Allow interactive commands to fail without triggering ERR trap
set +e
trap - ERR

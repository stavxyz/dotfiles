#!/usr/bin/env bash
#
# Module: bash_profile
# Description: Main bash profile - entry point for dotfiles
# Dependencies: All dotfiles modules
# URL: https://github.com/stavxyz/dotfiles

# ============================================================================
# Environment Setup
# ============================================================================

export ITERM_ENABLE_SHELL_INTEGRATION_WITH_TMUX=1
export BASH_SILENCE_DEPRECATION_WARNING=1
export DOTFILES_DIR=${DOTFILES_DIR:-~/dotfiles}

# PATH construction
export PATH="\
~/local/bin:\
/usr/local/bin:\
/usr/local/sbin:\
/usr/local/lib:\
/usr/bin:\
/bin:\
/usr/sbin:\
/sbin:\
/opt/X11/bin:\
~/.pyenv/bin:\
~/.local/bin:\
/opt/homebrew/opt/openjdk/bin:\
$PATH"

echo 'ðŸ’™'

# ============================================================================
# Bootstrap Utilities
# ============================================================================

errcho() { printf "%s\n" "$@" 1>&2; }
errxit() { errcho "$@"; exit 1; }
debug() {
  if [[ -n "${DOTFILES_DEBUG:-}" ]]; then
    errcho "$@"
  fi
}

# shellcheck disable=SC2120
_err() {
  errcho "$@"
  if [[ -n "${1:-}" ]]; then
    # Show the actual file and line where the error occurred
    local line="${1}"
    local func="${2:-}"
    local source_file="${BASH_SOURCE[1]:-${BASH_SOURCE[0]:-$0}}"

    # Show relative path if it's in dotfiles
    if [[ "$source_file" == "${DOTFILES_DIR}"* ]]; then
      source_file="${source_file#${DOTFILES_DIR}/}"
    fi

    local msg="â© Error at ${source_file}:${line}"
    [[ -n "$func" ]] && msg="${msg} in function '${func}'"
    errcho "$msg"
  fi
  errcho "â›”ï¸ Script failed."
}

_sigint() { errcho "ðŸ¿ Script discontinued."; exit 1; }

trap '_err ${LINENO} ${FUNCNAME:-}' ERR
trap '_sigint' SIGHUP SIGINT SIGTERM

# Propagate ERR trap to sourced scripts and functions
set -E

# ============================================================================
# Module Loading
# ============================================================================

[[ ! -d "${DOTFILES_DIR}" ]] && errcho 'dotfiles directory not found' && exit 0

# Convention: Auto-load all modules from bash/source/ in numeric order
for module in "${DOTFILES_DIR}"/bash/source/[0-9][0-9]-*.sh; do
  if [[ -f "$module" ]]; then
    debug "sourcing ${module##*/}"
    source "$module"
  fi
done

# Conditional: Homebrew (if brew binary exists)
if [[ -x "/opt/homebrew/bin/brew" ]] || [[ -x "/usr/local/bin/brew" ]]; then
  source "${DOTFILES_DIR}/homebrew/homebrew.sh"
fi

# Disable strict error checking for external scripts (completions, etc.)
# External bash completion scripts often have non-zero returns as normal behavior
set +E

# Lazy loading setup (function calls, not file sourcing)
setup_lazy_pyenv
setup_lazy_direnv
load_completions

# Platform-specific modules (macOS only)
if [[ $OSTYPE =~ darwin ]]; then
  source "${DOTFILES_DIR}/osx/osx.sh"
  source "${DOTFILES_DIR}/karabiner/karabiner.sh"
  source "${DOTFILES_DIR}/term/iterm2.sh"
fi

# ============================================================================
# Editor Preferences
# ============================================================================

# Use neovim if available, otherwise fall back to vim
if command -v nvim &>/dev/null; then
  export VISUAL=nvim EDITOR=nvim GIT_EDITOR=nvim
  alias vim="nvim" vi="nvim" oldvim="\vim"
else
  export VISUAL=vim EDITOR=vim GIT_EDITOR=vim
fi

# ============================================================================
# Interactive Mode
# ============================================================================

# Allow interactive commands to fail without triggering ERR trap
set +e
trap - ERR
